<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Officer Dashboard ‚Äî NETRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js" crossorigin=""></script>
  <script>
    // Stats Loading
    async function loadOfficerStats() {
      try {
        const res = await fetch('/api/officer_stats');
        const data = await res.json();
        document.getElementById('statFines').innerText = data.fines_today || 0;
        document.getElementById('statAlerts').innerText = data.resolved_total || 0;
      } catch (e) { console.error(e); }
    }

    // Patrol Log
    async function logPatrol() {
      if (!confirm("Log your current location as Patrol Check-in?")) return;

      // Mock Location
      const loc = "Lat: 28.61, Lng: 77.21 (GPS Mock)";

      try {
        await fetch('/api/log_patrol', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location: loc })
        });
        alert("‚úÖ Patrol Point Logged!");
      } catch (e) { alert("Error logging patrol"); }
    }

    window.addEventListener('load', loadOfficerStats);
  </script>
  <!-- Google Fonts: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Outfit', sans-serif;
    }

    .glass {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .gradient-text {
      background: linear-gradient(to right, #4ade80, #22d3ee);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .cam-feed {
      background-color: #000;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cam-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: rgba(0, 255, 0, 0.8);
      font-family: monospace;
      font-size: 0.75rem;
      z-index: 400;
      /* Leaflet uses high z-indices, be careful if map overlaps, but here they are separate */
      text-shadow: 0 0 2px black;
    }

    .rec-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: sans-serif;
      font-size: 0.7rem;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 10;
    }

    .rec-dot {
      width: 8px;
      height: 8px;
      background-color: red;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }

      100% {
        opacity: 1;
      }
    }

    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(0, 255, 100, 0.3);
      box-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
      animation: scan 4s linear infinite;
      opacity: 0.5;
      z-index: 5;
    }

    @keyframes scan {
      0% {
        top: -10%;
      }

      100% {
        top: 110%;
      }
    }

    .bg-sidebar {
      background-color: rgba(17, 34, 23, 0.8);
      backdrop-filter: blur(5px);
    }

    .accent {
      color: #13ec5b;
    }

    .nav-btn {
      display: block;
      padding: 12px;
      border-radius: 8px;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .nav-btn:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: #13ec5b;
      transform: translateX(4px);
    }

    .nav-btn.active {
      background-color: rgba(19, 236, 91, 0.1);
      color: #13ec5b;
      border-left: 3px solid #13ec5b;
    }

    .lang-opt {
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      font-size: 0.75rem;
      color: #d1d5db;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .lang-opt:hover {
      background-color: rgba(19, 236, 91, 0.2);
      color: #13ec5b;
    }

    @keyframes scan {
      0% {
        top: 0%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 100%;
        opacity: 0;
      }
    }

    @keyframes scan {
      0% {
        top: 0%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 100%;
        opacity: 0;
      }
    }
  </style>
</head>

<body
  class="bg-[#050b07] bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-[#0f2818] via-[#050b07] to-black text-white h-screen flex overflow-hidden">
  <!-- TOP NAVBAR -->
  <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm">
  </div>

  <header class="fixed top-0 left-0 right-0 z-50 h-14
               flex items-center gap-4
               bg-[#102216] border-b border-green-900 px-4">

    <!-- Hamburger -->
    <button onclick="toggleSidebar()"
      class="text-[#13ec5b] focus:outline-none focus:ring-2 focus:ring-[#13ec5b] rounded p-1"
      aria-label="Toggle Navigation" title="Toggle Sidebar">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"
        stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>

    <span class="font-bold text-[#13ec5b] text-lg flex-1">
      NETRA Officer
    </span>

    <!-- SOS BUTTON -->
    <button onclick="openSOSModal()" aria-label="Trigger SOS Emergency" title="Trigger SOS"
      class="bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded-full font-bold animate-pulse shadow-[0_0_15px_rgba(239,68,68,0.6)] mr-4 flex items-center gap-2 border border-red-400 focus:outline-none focus:ring-4 focus:ring-red-400">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
          clip-rule="evenodd" />
      </svg>
      SOS
    </button>

    <!-- NOTIFICATION BELL -->
    <div class="relative mr-2 group z-50">
      <button class="relative p-2 text-green-400 hover:text-white transition focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <span id="notificationDot"
          class="absolute top-1 right-1 h-2.5 w-2.5 bg-red-500 rounded-full animate-pulse hidden"></span>
      </button>

      <!-- Dropdown -->
      <div
        class="absolute right-0 top-full mt-2 w-80 bg-[#0a160f] border border-green-500/30 rounded-lg shadow-xl hidden group-hover:block z-50">
        <div class="p-3 border-b border-white/5 flex justify-between items-center">
          <h3 class="text-xs font-bold text-gray-400 uppercase">Notifications</h3>
          <button onclick="markAllRead()" class="text-xs text-blue-400 hover:text-white">Mark Read</button>
        </div>
        <div id="notificationList" class="max-h-60 overflow-y-auto custom-scrollbar p-1">
          <p class="text-center text-gray-500 text-xs py-4">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Language Selector -->
    <!-- Custom Language Selector -->
    <div class="relative mr-4 group z-50">
      <button id="langBtn"
        class="flex items-center gap-2 bg-[#102216] text-[#13ec5b] border border-[#13ec5b] text-xs rounded px-3 py-1.5 focus:outline-none hover:bg-[#13ec5b]/10 transition">
        <span id="currentLangLabel">Language</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <!-- Dropdown Menu -->
      <div class="absolute right-0 top-full pt-1 w-40 hidden group-hover:block z-50">
        <div class="bg-[#0a160f] border border-[#13ec5b]/30 rounded-lg shadow-xl overflow-hidden">
          <div class="max-h-60 overflow-y-auto custom-scrollbar-chat p-1 space-y-1">
            <button onclick="setLang('en', 'English')" class="lang-opt">English</button>
            <button onclick="setLang('hi', 'Hindi')" class="lang-opt">Hindi</button>
            <button onclick="setLang('ml', 'Malayalam')" class="lang-opt">Malayalam</button>
            <button onclick="setLang('fr', 'French')" class="lang-opt">French</button>
            <button onclick="setLang('es', 'Spanish')" class="lang-opt">Spanish</button>
            <button onclick="setLang('zh', 'Chinese')" class="lang-opt">Chinese</button>
            <button onclick="setLang('de', 'German')" class="lang-opt">German</button>
            <button onclick="setLang('ja', 'Japanese')" class="lang-opt">Japanese</button>
            <button onclick="setLang('ru', 'Russian')" class="lang-opt">Russian</button>
            <button onclick="setLang('ar', 'Arabic')" class="lang-opt">Arabic</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Bell -->
    <div class="relative mr-4 cursor-pointer"
      onclick="markSeen(); showSection('messages', document.querySelector('[onclick*=\'messages\']'));">
      <svg id="notificationBell" xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 text-gray-400 transition-colors duration-300" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <!-- Red Dot -->
      <span id="notificationDot"
        class="hidden absolute top-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-[#102216] bg-red-500"></span>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="fixed top-0 left-0 z-50 w-64 h-full
         bg-sidebar p-4 space-y-6
         transform -translate-x-full
         transition-transform duration-300 overflow-y-auto">


    <div>
      <h2 class="text-xl font-bold accent mb-6">NETRA Officer</h2>
      <!-- OFFICER PROFILE CARD -->
      <div class="flex items-center gap-3 bg-[#1a2e22] p-3 rounded">
        <div class="relative">
          <img id="officerPic" src="https://via.placeholder.com/60"
            class="w-14 h-14 rounded-full object-cover border border-green-400">
          <label for="profileUpload"
            class="absolute bottom-0 right-0 bg-green-500 text-black rounded-full p-1 cursor-pointer hover:bg-white transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
              <path
                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
            </svg>
          </label>
          <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="updateOfficerPic(event)">
        </div>
        <div>
          <h3 id="officerName" class="font-bold text-white leading-tight">Officer</h3>
          <p class="text-[0.65rem] text-green-400 uppercase tracking-wider">Active Duty</p>
        </div>
      </div>

      <!-- NEW: Patrol Check-in -->
      <button onclick="logPatrol()"
        class="w-full bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 border border-blue-500/50 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 group">
        <span>üìç Log Patrol Point</span>
      </button>

      <!-- NEW: Mini Stats -->
      <div class="grid grid-cols-2 gap-2 text-center text-xs">
        <div class="glass p-2 rounded">
          <p class="text-gray-400">Fines Today</p>
          <p id="statFines" class="text-lg font-bold text-white">--</p>
        </div>
        <div class="glass p-2 rounded">
          <p class="text-gray-400">Resolved</p>
          <p id="statAlerts" class="text-lg font-bold text-green-400">--</p>
        </div>
      </div>

      <nav class="space-y-2 mt-4">
        <button onclick="showSection('overview', this)" class="nav-btn active">
          <span class="mr-2">üìä</span> <span data-i18n="overview">Overview</span>
        </button>
        <button class="nav-btn" onclick="showSection('cases', this)" data-i18n="cases">Case Files</button>
        <button class="nav-btn" onclick="showSection('map', this)" data-i18n="tactical_map">Tactical Map</button>
        <button class="nav-btn" onclick="showSection('alerts', this)" data-i18n="alerts">System Alerts</button>
        <button class="nav-btn" onclick="showSection('analysis', this)" data-i18n="analysis">Analysis</button>
        <button class="nav-btn" onclick="showSection('reports', this)" data-i18n="reports">Reports</button>
        <button class="nav-btn" onclick="showSection('messages', this)" data-i18n="messages">Messages</button>
        <button class="nav-btn text-orange-400" onclick="showSection('ai_reviews', this); loadReviews()">
          <span>‚ö†Ô∏è AI Reviews</span>
        </button>
        <button class="nav-btn" onclick="showSection('activity_log', this); loadActivityLogs()"
          data-i18n="activity_log">Activity Log</button>
        <button class="nav-btn" onclick="showSection('settings', this)" data-i18n="settings">Settings</button>
        <a href="/help" class="nav-btn" data-i18n="help">Help & FAQ</a>
      </nav>
    </div>
    <button class="nav-btn" onclick="showSection('profile', this)" data-i18n="profile">
      Profile
    </button>

    <a href="/logout" data-i18n="logout"
      class="block w-full text-left p-3 mt-8 bg-red-900/30 text-red-400 rounded hover:bg-red-900/50 hover:text-red-300 font-bold transition-colors">
      Logout
    </a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-6 overflow-y-auto pt-16">

    <!-- DASHBOARD -->
    <section id="dashboard" class="section">
      <h1 class="text-3xl font-bold mb-1 tracking-tight"><span data-i18n="command_center">Command Center</span></h1>
      <p class="text-sm text-[#a7f3d0] mb-6">System Online</p>

      <!-- QUICK ACTIONS -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <button onclick="triggerAction('alarm')"
          class="bg-red-600/20 text-red-400 border border-red-600 px-4 py-3 rounded hover:bg-red-600 hover:text-white transition"
          data-i18n="trigger_alarm">Trigger
          Alarm</button>
        <button onclick="triggerAction('spotlight')"
          class="bg-yellow-500/20 text-yellow-400 border border-yellow-500 px-4 py-3 rounded hover:bg-yellow-500 hover:text-black transition"
          data-i18n="spotlight">Spotlight</button>
        <button onclick="triggerAction('broadcast')"
          class="glass border border-[#13ec5b]/30 px-4 py-3 rounded hover:bg-[#1f3b2b] transition"
          data-i18n="broadcast">Broadcast</button>
        <button onclick="triggerAction('redirect')"
          class="glass border border-[#13ec5b]/30 px-4 py-3 rounded hover:bg-[#1f3b2b] transition text-green-300"
          data-i18n="redirect_crowd">Redirect Crowd</button>
        <button onclick="openChallanModal()"
          class="bg-blue-600/20 text-blue-400 border border-blue-600 px-4 py-3 rounded hover:bg-blue-600 hover:text-white transition"
          data-i18n="issue_challan">Report Incident</button>
      </div>

      <!-- SUSPECT SEARCH ENGINE -->
      <div class="glass p-6 rounded-xl border border-blue-500/30 mb-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>üîé</span> <span data-i18n="suspect_search">Find Suspect in Crowd</span>
        </h2>
        <div class="flex gap-4 mb-4">
          <input id="suspectQuery" type="text" placeholder="e.g. Red Shirt, Backpack, Running..."
            class="w-full glass p-3 rounded text-white border-white/20 focus:border-blue-500 outline-none placeholder-gray-500">
          <button onclick="searchSuspects()"
            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded font-bold shadow-lg shadow-blue-500/30 transition">
            Scan Cameras
          </button>
        </div>

        <div id="searchResults" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
          <!-- Results injected here -->
        </div>
      </div>

      <!-- LIVE FEEDS -->
      <h2 class="text-xl font-bold mb-4" data-i18n="live_surveillance">Live Surveillance</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Cam 1 -->
        <div class="cam-feed rounded-xl h-48 relative group">
          <div class="cam-overlay">CAM-01 [GATE]</div>
          <div class="rec-indicator">
            <div class="rec-dot"></div> LIVE
          </div>
          <div class="scan-line"></div>
          <div class="scan-line"></div>
          <img src="https://images.unsplash.com/photo-1541888946425-d81bb19240f5?q=80&w=600&auto=format&fit=crop"
            class="w-full h-full object-cover opacity-60" alt="Live surveillance feed from Gate Camera">
        </div>
        <!-- Cam 2 -->
        <div class="cam-feed rounded-xl h-48 relative group">
          <div class="cam-overlay">CAM-02 [LOBBY]</div>
          <div class="rec-indicator">
            <div class="rec-dot"></div> LIVE
          </div>
          <div class="scan-line" style="animation-delay: 1.5s;"></div>
          <img src="https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=600&auto=format&fit=crop"
            class="w-full h-full object-cover opacity-60" alt="Live surveillance feed from Lobby Camera">
        </div>
      </div>
    </section>

    <!-- CROWD DENSITY MONITOR -->
    <section class="section mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" data-i18n="crowd_density">Crowd Density Monitoring</h2>
        <span class="text-xs text-gray-400 animate-pulse">‚óè Live Analysis</span>
      </div>
      <div id="crowdContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Populated by JS -->
        <div class="glass p-4 rounded text-center">
          <p class="text-gray-500">Connecting to sensors...</p>
        </div>
      </div>
    </section>

    <!-- RECORD CONSOLE (Dynamic) -->
    <section id="alerts" class="section hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Records Console</h2>
        <div class="flex gap-2">
          <input type="text" id="recordSearch" onkeyup="filterRecords()" placeholder="Search keywords..."
            class="glass text-white px-3 py-1 rounded border border-green-800 text-sm">
          <select id="recordFilter" onchange="filterRecords()"
            class="glass text-white px-3 py-1 rounded border border-green-800 text-sm">
            <option value="all">All Status</option>
            <option value="unresolved">Unresolved</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
      </div>

      <div class="glass rounded-xl overflow-x-auto border border-white/5">
        <table class="w-full text-sm text-left">
          <thead class="text-xs uppercase bg-white/5 text-gray-400 border-b border-white/5">
            <tr>
              <th class="px-4 py-3">ID</th>
              <th class="px-4 py-3">Time</th>
              <th class="px-4 py-3">Source</th>
              <th class="px-4 py-3">Message</th>
              <th class="px-4 py-3">Severity</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Action</th>
            </tr>
          </thead>
          <tbody id="recordsTableBody" class="divide-y divide-white/5">
            {% for alert in alerts %}
            <tr class="record-row hover:bg-white/5 transition duration-150"
              data-content="{{ alert.message|e }} {{ alert.source|e }} {{ alert.id }}" data-status="{{ alert.status }}">
              <td class="px-4 py-3 font-mono text-emerald-400">#{{ alert.id }}</td>
              <td class="px-4 py-3 text-gray-400">{{ alert.created_at }}</td>
              <td class="px-4 py-3 font-bold text-gray-200">{{ alert.source }}</td>
              <td class="px-4 py-3 text-gray-300">{{ alert.message }}</td>
              <td class="px-4 py-3">
                {% if alert.severity == 'Critical' %}
                <span
                  class="bg-red-500/20 text-red-300 py-1 px-2 rounded text-xs font-bold border border-red-500/20 shadow-[0_0_10px_rgba(239,68,68,0.2)]">CRITICAL</span>
                {% elif alert.severity == 'Warning' %}
                <span
                  class="bg-yellow-500/20 text-yellow-300 py-1 px-2 rounded text-xs font-bold border border-yellow-500/20">WARNING</span>
                {% else %}
                <span
                  class="bg-green-500/20 text-green-300 py-1 px-2 rounded text-xs font-bold border border-green-500/20">INFO</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                <span id="status-{{alert.id}}"
                  class="py-1 px-2 rounded text-xs font-bold {{ 'bg-green-500/20 text-green-400 border border-green-500/20' if alert.status =='Resolved' else 'bg-red-500/20 text-red-400 border border-red-500/20' }}">
                  {{ alert.status }}
                </span>
              </td>
              <td class="px-4 py-3">
                {% if alert.status != 'Resolved' %}
                <button onclick="updateStatus('{{ alert.id }}', 'Resolved')"
                  class="bg-[#13ec5b] text-black px-2 py-1 rounded text-xs hover:bg-green-400 font-bold shadow-lg shadow-green-500/20">Resolve</button>
                {% else %}
                <span class="text-gray-600 text-xs">No Action</span>
                {% endif %}

                <!-- Share Button -->
                <button onclick="shareAlert('{{ alert.message|e }}', '{{ alert.source|e }}')"
                  class="ml-2 text-blue-400 hover:text-white border border-blue-500/30 px-2 py-1 rounded text-xs transition focus:ring-2 focus:ring-blue-400 focus:outline-none"
                  aria-label="Share Alert" title="Share Alert">
                  Share
                </button>

                <!-- Navigate Button -->
                <button onclick="navigateToAlert('{{ alert.message|e }}')"
                  class="ml-2 text-yellow-400 hover:text-white border border-yellow-500/30 px-2 py-1 rounded text-xs transition focus:ring-2 focus:ring-yellow-400 focus:outline-none"
                  aria-label="View Location on Map" title="View location on map">
                  üìç
                </button>
              </td>
            </tr>
            {% endfor %}
            {% if not alerts %}
            <tr>
              <td colspan="7" class="px-4 py-6 text-center text-gray-500 italic">No records found using current
                connection.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- ANALYSIS -->
    <section id="analysis" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Data Analysis</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-4 rounded">
          <h3 class="font-bold mb-4 text-sm text-gray-400">Alert Severity Distribution</h3>
          <div class="h-64">
            <canvas id="severityChart"></canvas>
          </div>
        </div>
        <div class="glass p-4 rounded flex flex-col justify-center">
          <div class="text-center mb-6">
            <p class="text-4xl font-bold text-[#13ec5b] mb-1">{{ alerts|length }}</p>
            <p class="text-sm text-gray-400">Total Records</p>
          </div>
          <div class="text-center">
            <p class="text-4xl font-bold text-yellow-400 mb-1">
              {% set ns = namespace(pending=0) %}
              {% for a in alerts if a.status != 'Resolved' %}{% set ns.pending = ns.pending + 1 %}{% endfor %}
              {{ ns.pending }}
            </p>
            <p class="text-sm text-gray-400">Pending Actions</p>
          </div>
        </div>
      </div>
    </section>

    <!-- MAP VIEW -->
    <section id="map" class="section hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" data-i18n="tactical_map">Tactical Map</h2>
        <button onclick="toggleHeatmap()" data-i18n="toggle_heatmap"
          class="bg-[#13ec5b]/20 text-[#13ec5b] px-3 py-1 rounded border border-[#13ec5b] hover:bg-[#13ec5b] hover:text-black transition text-sm font-bold">
          Toggle Heatmap
        </button>
      </div>
      <div class="glass p-2 rounded-xl">
        <div id="officerMap" class="h-96 w-full rounded-lg z-0"></div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Reports</h2>
      <div class="glass p-4 rounded flex justify-between items-center">
        <div>
          <h3 class="font-bold text-lg">Download Reports</h3>
          <p class="text-sm text-gray-400">Export incident logs and alerts to Excel.</p>
        </div>
        <a href="/export_reports" class="bg-[#13ec5b] text-black px-4 py-2 rounded hover:bg-green-400 font-bold">
          Export to Excel
        </a>
      </div>
    </section>

    <!-- MESSAGES -->
    <section id="messages" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Messages</h2>
      <div class="glass p-6 rounded-xl border border-white/5 mb-6">
        <h3 class="panel-title mb-4 font-bold text-emerald-400">Comms with HQ</h3>

        <!-- Compose -->
        <div class="mb-4 space-y-2">
          <div class="flex gap-2">
            <select id="msgRecipient"
              class="glass p-2 rounded text-sm border-white/10 w-1/3 text-gray-300 focus:outline-none focus:border-green-500">
              <option value="" disabled selected class="bg-black">Select Recipient...</option>
              {% for user in recipients %}
              <option value="{{ user.id }}"
                class="bg-black {{ 'font-bold text-green-400' if user.role == 'admin' else '' }}">
                {{ user.name }} ({{ user.role|capitalize }})
              </option>
              {% endfor %}
            </select>

            <input id="msgContent" type="text" placeholder="Type a message..."
              class="glass p-2 rounded text-sm border-white/10 w-full text-white placeholder-gray-500 focus:outline-none focus:border-green-500">
            <button onclick="sendMessage()"
              class="bg-gradient-to-r from-green-500 to-emerald-600 text-black px-4 py-2 rounded hover:from-green-400 hover:to-emerald-500 font-bold shadow-lg shadow-green-500/20 transition-all duration-300">
              Send
            </button>
          </div>
        </div>

        <!-- Log -->
        <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Inbox / Sent</h4>
        <div class="h-[400px] overflow-y-auto space-y-3 custom-scrollbar pr-2">
          {% for msg in messages %}
          <div
            class="p-3 rounded-lg text-sm shadow-sm {{ 'bg-emerald-900/20 ml-12 border-l-2 border-emerald-500 self-end text-right' if msg.sender_id == session.user.id else 'bg-white/5 mr-12 border-r-2 border-gray-600' }}">
            <div
              class="flex justify-between text-xs text-gray-500 mb-1 {{ 'flex-row-reverse' if msg.sender_id == session.user.id }}">
              <span class="font-bold text-gray-400">
                {% if msg.sender_id == session.user.id %}
                You ‚ûî Admin
                {% else %}
                {{ msg.sender_name }} ‚ûî You
                {% endif %}
              </span>
              <span>{{ msg.timestamp }}</span>
            </div>
            <p class="text-gray-200">{{ msg.content }}</p>
          </div>
          {% endfor %}
          {% if not messages %}
          <div class="flex flex-col items-center justify-center h-full text-gray-500 space-y-2">
            <span class="text-2xl opacity-20">üí¨</span>
            <p class="text-xs italic">No messages.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- CASES SECTION -->
    <section id="cases" class="section hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">My Case Files</h2>
        <button onclick="openCreateCaseModal()"
          class="bg-[#13ec5b] text-black px-4 py-2 rounded hover:bg-green-400 font-bold shadow-lg shadow-green-500/20 flex items-center gap-2">
          <span>+</span> Create New Case
        </button>
      </div>

      <div class="glass p-6 rounded-xl border border-white/5">
        <h3 class="panel-title mb-4 font-bold text-blue-400">Assigned Investigations</h3>

        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead>
              <tr class="text-gray-400 border-b border-gray-700">
                <th class="py-3 px-4">Case ID</th>
                <th class="py-3 px-4">Title</th>
                <th class="py-3 px-4">Status</th>
                <th class="py-3 px-4">Created Date</th>
                <th class="py-3 px-4">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for case in my_cases %}
              <tr class="border-b border-gray-800 hover:bg-white/5 transition">
                <td class="py-3 px-4 font-mono text-green-400">{{ case.case_id }}</td>
                <td class="py-3 px-4 font-bold">{{ case.title }}</td>
                <td class="py-3 px-4">
                  <span
                    class="px-2 py-1 rounded text-xs border 
                    {{ 'border-green-500/30 text-green-400 bg-green-500/10' if case.status=='Open' else 'border-gray-500/30 text-gray-400' }}">
                    {{ case.status }}
                  </span>
                </td>
                <td class="py-3 px-4 text-gray-400">{{ case.created_at }}</td>
                <td class="py-3 px-4">
                  <button onclick="openCaseDetails('{{ case.case_id }}')"
                    class="text-blue-400 hover:text-blue-300 text-xs border border-blue-500/30 px-2 py-1 rounded">
                    View Details
                  </button>
                </td>
              </tr>
              {% endfor %}
              {% if not my_cases %}
              <tr>
                <td colspan="5" class="py-8 text-center text-gray-500 italic">No assigned cases found.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CREATE CASE MODAL -->
    <div id="createCaseModal"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
      <div class="glass p-8 rounded-2xl max-w-lg w-full border border-green-500/30 shadow-2xl relative">
        <h2 class="text-2xl font-bold text-white mb-6">Create New Investigation</h2>

        <div class="space-y-4">
          <div>
            <label class="text-sm text-gray-400 block mb-1">Case Title</label>
            <input id="caseTitle" type="text" placeholder="e.g. Suspicious Activity at Gate 4"
              class="w-full glass p-3 rounded text-white border-white/10 focus:border-green-500 outline-none">
          </div>

          <div>
            <label class="text-sm text-gray-400 block mb-1">Description / Initial Report</label>
            <textarea id="caseDesc" rows="4" placeholder="Describe the incident details..."
              class="w-full glass p-3 rounded text-white border-white/10 focus:border-green-500 outline-none"></textarea>
          </div>

          <div class="flex gap-4 mt-8 pt-4 border-t border-white/10">
            <button onclick="closeCreateCaseModal()"
              class="flex-1 py-3 rounded border border-gray-600 hover:bg-gray-800 text-gray-400">Cancel</button>
            <button onclick="createCase()"
              class="flex-1 py-3 rounded bg-green-600 hover:bg-green-500 text-white font-bold shadow-lg shadow-green-500/30">Create
              Case</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CASE DETAILS & EVIDENCE MODAL -->
    <div id="caseDetailsModal"
      class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
      <div
        class="glass p-8 rounded-2xl max-w-4xl w-full border border-blue-500/30 shadow-2xl relative h-[90vh] flex flex-col">
        <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-4">
          <div>
            <h2 id="cdTitle" class="text-2xl font-bold text-white">Case #ID</h2>
            <p id="cdStatus" class="text-sm text-green-400 mt-1">Status: Open</p>
          </div>
          <div class="flex items-center gap-4">
            <a id="exportReportBtn" href="#" target="_blank"
              class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded text-sm transition font-bold flex items-center gap-2">
              üìÑ Export Report
            </a>
            <button onclick="closeCaseDetailsModal()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar space-y-8 pr-2">
          <!-- Description -->
          <div class="bg-white/5 p-4 rounded-lg">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Incident Report</h3>
            <p id="cdDesc" class="text-gray-300 whitespace-pre-wrap">Loading...</p>
          </div>

          <!-- Evidence Section -->
          <div>
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-blue-400">Evidence Locker</h3>
              <label for="evidenceUpload"
                class="cursor-pointer bg-blue-600/20 text-blue-400 border border-blue-600 px-4 py-2 rounded hover:bg-blue-600 hover:text-white transition flex items-center gap-2">
                <span>‚¨Ü</span> Upload Evidence
              </label>
              <input type="file" id="evidenceUpload" class="hidden" onchange="handleEvidenceSelection(this)">
            </div>

            <!-- Upload Preview (Hidden by default) -->
            <div id="uploadPreview" class="hidden glass p-4 rounded-lg mb-4 border border-blue-500/30">
              <h4 class="font-bold text-white mb-2">New Upload</h4>
              <div class="flex gap-4 items-end">
                <div class="flex-1">
                  <span id="fileName" class="text-sm text-gray-400 block mb-2">filename.jpg</span>
                  <input id="evidenceTags" type="text" placeholder="Tags (e.g. weapon, vehicle, suspect)"
                    class="w-full glass p-2 rounded text-white border-white/10 focus:border-blue-500 outline-none text-sm">
                </div>
                <button onclick="uploadEvidence()"
                  class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold shadow-lg">Confirm
                  Upload</button>
                <button onclick="cancelUpload()" class="text-red-400 hover:text-white px-3 py-2">Cancel</button>
              </div>
            </div>

            <!-- Evidence List -->
            <div class="glass rounded-xl overflow-hidden border border-white/5">
              <table class="w-full text-sm text-left">
                <thead class="bg-white/5 text-gray-400 uppercase text-xs">
                  <tr>
                    <th class="p-3">File</th>
                    <th class="p-3">Type</th>
                    <th class="p-3">Tags</th>
                    <th class="p-3">Status</th>
                    <th class="p-3">Uploaded</th>
                    <th class="p-3">Action</th>
                  </tr>
                </thead>
                <tbody id="evidenceListBody">
                  <!-- Populated by JS -->
                </tbody>
              </table>
              <p id="noEvidenceMsg" class="p-4 text-center text-gray-500 italic hidden">No evidence collected yet.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <section id="settings" class="section hidden">
        <h2 class="text-xl font-bold mb-4">Settings</h2>
        <div class="glass p-6 rounded-xl max-w-lg">
          <label class="block mb-4">
            Alert Volume
            <input type="range" class="w-full mt-2 accent-green-500">
          </label>
          <button
            class="bg-[#13ec5b] text-black px-6 py-2 rounded hover:bg-green-400 font-bold shadow-lg shadow-green-500/20">
            Save Settings
          </button>
        </div>
      </section>



      <!-- PROFILE -->
      <section id="profile" class="section hidden flex justify-center">
        <div class="glass p-8 rounded-2xl max-w-lg w-full relative overflow-hidden">
          <!-- Decoration -->
          <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-500/20 rounded-full blur-3xl pointer-events-none">
          </div>

          <h2 class="text-xl font-bold mb-6 text-center">Officer Profile</h2>

          <!-- Profile Picture -->
          <div class="flex flex-col items-center gap-4 mb-6">
            <div class="relative group">
              <img id="officerPicPreview" src="https://via.placeholder.com/120"
                class="w-28 h-28 rounded-full object-cover border-4 border-white/5 group-hover:border-green-400 transition-all duration-300 shadow-xl">
              <div
                class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none">
                <span class="text-xs font-bold text-white">Change</span>
              </div>
            </div>
            <input type="file" accept="image/*" onchange="updateOfficerPic(event)"
              class="text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-500/10 file:text-green-400 hover:file:bg-green-500/20">
          </div>

          <!-- Profile Fields -->
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-400 ml-1">Username (Email)</label>
              <input id="officerUsername" class="w-full glass p-3 rounded-lg text-white"
                value="{{ session.user.email }}" readonly>
            </div>

            <div>
              <label class="text-sm text-gray-400 ml-1">Full Name</label>
              <input id="officerProfileName" class="w-full glass p-3 rounded-lg text-white"
                value="{{ session.user.name }}" readonly>
            </div>

            <div>
              <label class="text-sm text-gray-400 ml-1">Role</label>
              <input class="w-full glass p-3 rounded-lg text-gray-400" value="{{ session.user.role|capitalize }}"
                disabled>
            </div>

            <!-- Save button removed as it only saved to local storage incorrectly -->
            <!-- Re-enabling for visual completeness even if backend logic is stubbed in this context -->
            <button onclick="saveOfficerProfile()"
              class="bg-gradient-to-r from-green-600 to-emerald-700 text-white p-3 rounded-lg w-full font-bold hover:shadow-lg hover:shadow-green-500/20 hover:scale-[1.02] transition-all duration-300 mt-4">
              Save Profile
            </button>
          </div>
        </div>
      </section>

      <!-- SOS MODAL -->
      <div id="sosModal"
        class="fixed inset-0 bg-red-900/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div
          class="glass p-8 rounded-2xl max-w-md w-full border border-red-500 shadow-[0_0_50px_rgba(220,38,38,0.5)] text-center space-y-6 relative overflow-hidden">
          <!-- Animated Background -->
          <div class="absolute inset-0 bg-red-600/10 animate-pulse pointer-events-none"></div>

          <div class="relative z-10">
            <div
              class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_20px_#ef4444]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd" />
              </svg>
            </div>

            <h2 class="text-3xl font-bold text-white mb-2">EMERGENCY SOS</h2>
            <p class="text-red-200 text-sm mb-6">This will alert Admin and broadcast your live location to all nearby
              units.</p>

            <div class="grid grid-cols-1 gap-3">
              <button onclick="triggerSOS('medical')"
                class="bg-red-600 hover:bg-red-500 text-white p-4 rounded-xl font-bold transition transform hover:scale-105 shadow-lg border border-red-400">
                üöë MEDICAL EMERGENCY
              </button>
              <button onclick="triggerSOS('backup')"
                class="bg-orange-600 hover:bg-orange-500 text-white p-4 rounded-xl font-bold transition transform hover:scale-105 shadow-lg border border-orange-400">
                üëÆ REQUEST BACKUP
              </button>
              <button onclick="triggerSOS('fire')"
                class="bg-yellow-600 hover:bg-yellow-500 text-white p-4 rounded-xl font-bold transition transform hover:scale-105 shadow-lg border border-yellow-400">
                üî• FIRE / HAZARD
              </button>
            </div>

            <button onclick="closeSOSModal()"
              class="mt-6 text-gray-400 hover:text-white underline text-sm">Cancel</button>
          </div>
        </div>
      </div>

      <!-- AI FEEDBACK MODAL -->
      <div id="aiFeedbackModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="glass p-6 rounded-2xl max-w-sm w-full border border-purple-500/30 relative">
          <h3 class="text-lg font-bold text-purple-400 mb-4">Review AI Detection</h3>
          <p class="text-sm text-gray-300 mb-4">Was the AI analysis for this file correct?</p>

          <input type="hidden" id="feedbackEvidenceId">

          <div class="space-y-3">
            <button onclick="submitFeedback('Correct')"
              class="w-full bg-green-900/40 text-green-400 border border-green-500/30 p-2 rounded hover:bg-green-900/60">
              ‚úî Correct Detection
            </button>
            <button onclick="submitFeedback('False Positive')"
              class="w-full bg-red-900/40 text-red-400 border border-red-500/30 p-2 rounded hover:bg-red-900/60">
              ‚úñ False Positive
            </button>
            <button onclick="submitFeedback('Missed Object')"
              class="w-full bg-yellow-900/40 text-yellow-400 border border-yellow-500/30 p-2 rounded hover:bg-yellow-900/60">
              ‚ö† Missed Object
            </button>
          </div>

          <textarea id="feedbackComment" placeholder="Optional comments..."
            class="w-full glass mt-4 p-2 rounded text-sm text-white focus:outline-none border-white/10"></textarea>

          <button onclick="closeFeedbackModal()"
            class="mt-4 text-gray-500 text-xs w-full hover:text-white">Cancel</button>
        </div>
      </div>
      <div
        class="glass p-8 rounded-2xl max-w-md w-full border border-blue-500 shadow-[0_0_30px_rgba(59,130,246,0.5)] relative">
        <h2 class="text-2xl font-bold text-white mb-4">File Incident Report</h2>

        <div class="space-y-4">
          <div>
            <label class="text-sm text-gray-400">Suspect Name / Description</label>
            <input id="challanName" type="text" placeholder="e.g. Male in Red Shirt"
              class="w-full glass p-2 rounded text-white border-white/20 focus:border-blue-500 outline-none">
          </div>

          <div>
            <label class="text-sm text-gray-400">Incident Type</label>
            <select id="challanReason"
              class="w-full glass p-2 rounded text-white border-white/20 focus:border-blue-500 outline-none bg-black">
              <option value="Suspicious Activity">Suspicious Activity</option>
              <option value="Public Disturbance">Public Disturbance/Panic</option>
              <option value="Unauthorised Objects">Unauthorised Objects (Weapons/Bags)</option>
              <option value="Trespassing">Trespassing</option>
              <option value="Loitering">Loitering</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-400">Evidence (Photo)</label>
            <input id="challanEvidence" type="file" accept="image/*"
              class="w-full glass p-2 rounded text-white border-white/20 focus:border-blue-500 outline-none text-sm">
          </div>

          <!-- HIDDEN AMOUNT FIELD (Not relevant for security report) -->
          <div class="hidden">
            <label class="text-sm text-gray-400">Fine Amount (‚Çπ)</label>
            <input id="challanAmount" type="number"
              class="w-full glass p-2 rounded text-white border-white/20 focus:border-blue-500 outline-none" value="0">
          </div>

          <div id="challanResult" class="hidden p-3 bg-green-500/20 text-green-400 rounded text-sm break-all"></div>

          <div class="flex gap-3 mt-6">
            <button onclick="closeChallanModal()"
              class="flex-1 py-2 rounded border border-gray-600 hover:bg-gray-800 text-gray-400">Cancel</button>
            <button onclick="issueChallan()"
              class="flex-1 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-500/30">
              Submit Report</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PENDING AI REVIEWS -->
    <section id="ai_reviews" class="section hidden">
      <h2 class="section-title">Pending AI Reviews</h2>
      <div class="glass p-6 rounded-xl">
        <h3 class="panel-title mb-4 text-orange-400">Automated Violation Alerts</h3>
        <p class="text-sm text-gray-400 mb-6">Review detections flagged by the AI system. Confirm violations to issue
          fines or dismiss false positives.</p>

        <div id="reviewContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Populated by JS -->
          <p class="text-gray-500 italic">No pending reviews.</p>
        </div>
      </div>
    </section>

    <!-- ACTIVITY LOG -->
    <section id="activity_log" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Activity Log</h2>
      <div class="glass p-6 rounded-xl border border-white/5">
        <h3 class="panel-title mb-4 font-bold text-blue-400">Officer Actions History</h3>

        <div id="activityLogContainer" class="space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">
          <p class="text-gray-500 italic text-center py-4">Loading operational logs...</p>
          <!-- JS will populate -->
        </div>
      </div>
    </section>

    {% include 'component_chatbot.html' %}
  </main>

  <!-- JS -->
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      sidebar.classList.toggle("-translate-x-full");
      overlay.classList.toggle("hidden");
    }

    /* Close sidebar after clicking any menu item */
    /* Event Listeners replaced by direct call in showSection to handle mobile check */
    /* ---------- SECTION SWITCHING ---------- */
    function showSection(id, btn) {
      document.querySelectorAll('.section').forEach(sec => {
        sec.classList.add('hidden');
      });

      const target = document.getElementById(id);
      if (target) target.classList.remove('hidden');

      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('active');
      });
      if (btn) btn.classList.add('active');

      // Trigger chart resize if analysis section is shown
      if (id === 'analysis' && window.myChart) {
        window.myChart.resize();
      }

      // Auto-hide sidebar on mobile
      // Auto-hide sidebar
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      if (sidebar && !sidebar.classList.contains("-translate-x-full")) {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
      }
    }

    function updateOfficerPic(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        localStorage.setItem("officerPic", reader.result);
        document.getElementById("officerPic").src = reader.result;
        document.getElementById("officerPicPreview").src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    async function saveOfficerProfile() {
      const name = document.getElementById("officerNameInput").value;
      if (!name) return alert("Name is required");

      try {
        const res = await fetch('/api/update_profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        });
        const data = await res.json();
        if (data.success) {
          alert("Profile saved successfully!");
          document.getElementById("officerName").innerText = name; // Update sidebar
        } else {
          alert("Error: " + data.error);
        }
      } catch (e) { console.error(e); alert("Server error"); }
    }

    /* LOAD OFFICER PROFILE DATA */
    window.addEventListener("load", () => {
      // Only load picture from local storage if needed. 
      // Text fields are now populated by server session data.
      if (localStorage.getItem("officerPic")) {
        const pic = localStorage.getItem("officerPic");
        const el1 = document.getElementById("officerPic");
        const el2 = document.getElementById("officerPicPreview");
        if (el1) el1.src = pic;
        if (el2) el2.src = pic;
      }

      initChart();
    });

    /* ---------- SEARCH & FILTER ---------- */
    console.log("Dashboard Script Loaded");
    /* ---------- SEARCH & FILTER ---------- */
    // filterRecords defined below in extended block


    /* ---------- UPDATE STATUS ---------- */
    async function updateStatus(id, newStatus) {
      if (!confirm("Mark this record as Resolved?")) return;

      try {
        const res = await fetch('/api/update_alert_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, status: newStatus })
        });
        const data = await res.json();

        if (data.success) {
          // Update UI without reload
          const statusBadge = document.getElementById(`status-${id}`);
          if (statusBadge) {
            statusBadge.innerText = newStatus;
            statusBadge.className = "py-1 px-2 rounded text-xs font-bold bg-green-500/20 text-green-400";
          }
          // Update data attribute for filter
          const row = statusBadge.closest('tr');
          if (row) row.setAttribute('data-status', newStatus);
        } else {
          alert("Failed to update status: " + data.error);
        }
      } catch (e) {
        console.error(e);
        alert("Server error");
      }
    }

    /* ---------- CHALLAN LOGIC ---------- */
    function openChallanModal() {
      document.getElementById("challanModal").classList.remove("hidden");
    }

    function closeChallanModal() {
      document.getElementById("challanModal").classList.add("hidden");
      document.getElementById("challanResult").classList.add("hidden");
      document.getElementById("challanName").value = "";
    }

    async function issueChallan() {
      const name = document.getElementById("challanName").value;
      const reason = document.getElementById("challanReason").value;
      const amount = document.getElementById("challanAmount").value;
      const fileInput = document.getElementById("challanEvidence");

      if (!amount || !reason) return alert("Please fill details");

      const formData = new FormData();
      formData.append("violator_name", name);
      formData.append("reason", reason);
      formData.append("amount", amount);
      if (fileInput.files[0]) {
        formData.append("evidence", fileInput.files[0]);
      }

      try {
        const res = await fetch('/api/issue_challan', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          const resDiv = document.getElementById("challanResult");
          resDiv.innerHTML = `Fine Issued! <br> <a href="${data.payment_link}" target="_blank" class="underline font-bold">Payment Link</a>`;
          resDiv.classList.remove("hidden");
        } else {
          alert("Error: " + data.error);
        }
      } catch (e) {
        alert("Server Error");
      }
    }

    /* ---------- SHARE ALERT ---------- */
    function shareAlert(message, source) {
      const text = `ALERT REPORT\nSource: ${source}\nMessage: ${message}\n- NETRA System`;
      const encodedText = encodeURIComponent(text);

      // Simple selection dialog logic (using browser native for simplicity or creating a modal)
      // For quick implementation:
      const choice = prompt("Share via (type number):\n1. WhatsApp\n2. Email", "1");

      if (choice === '1') {
        window.open(`https://wa.me/?text=${encodedText}`, '_blank');
      } else if (choice === '2') {
        window.location.href = `mailto:?subject=NETRA%20Alert&body=${encodedText}`;
      }
    }

    async function sendMessage() {
      // Get Recipient ID from dropdown
      const recipient = document.getElementById('msgRecipient').value;
      const content = document.getElementById('msgContent').value;

      if (!recipient) return alert("Please select a recipient.");
      if (!content.trim()) return alert("Please enter a message.");

      try {
        const res = await fetch('/api/send_message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ receiver_id: recipient, content: content })
        });
        const data = await res.json();
        if (data.success) {
          window.location.reload();
        } else {
          alert("Error: " + data.error);
        }
      } catch (err) {
        console.error(err);
        alert("Failed to send message.");
      }
    }

    /* ---------- CHART.JS ---------- */
    function initChart() {
      const ctx = document.getElementById('severityChart');
      if (!ctx) return;

      // Count severities from table (or jinja injected)
      // We will parse the rows to be dynamic
      let high = 0, med = 0, low = 0;
      document.querySelectorAll('.record-row').forEach(row => {
        const html = row.innerHTML;
        if (html.includes('CRITICAL')) high++;
        else if (html.includes('WARNING')) med++;
        else low++;
      });

      window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Critical', 'Warning', 'Info'],
          datasets: [{
            data: [high, med, low],
            backgroundColor: ['#ef4444', '#facc15', '#22c55e'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#fff' }
            }
          }
        }
      });
    }

    /* ---------- POLLING & NOTIFICATIONS ---------- */
    let lastMsgId = 0;

    async function pollState() {
      try {
        // 1. Sync State (Messages)
        const res = await fetch('/api/sync_state');
        if (res.ok) {
          const data = await res.json();
          if (lastMsgId === 0) lastMsgId = data.latest_msg_id;
          // Message logic handled typically by chat reload, here we just track ID
        }

        // 2. Fetch Notifications
        fetchNotifications();

      } catch (e) { console.error("Poll error", e); }
    }

    async function fetchNotifications() {
      try {
        const res = await fetch('/api/get_notifications');
        const notifs = await res.json();

        const list = document.getElementById('notificationList');
        const dot = document.getElementById('notificationDot');

        if (notifs.length === 0) {
          list.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">No notifications.</p>';
          dot.classList.add('hidden');
          return;
        }

        let hasUnread = false;
        let html = '';

        notifs.forEach(n => {
          if (!n.is_read) hasUnread = true;
          const bg = n.is_read ? 'opacity-50' : 'bg-white/5';
          html += `
                  <div class="p-2 border-b border-white/5 last:border-0 ${bg} hover:bg-white/10 transition cursor-pointer" onclick="markRead(${n.id})">
                    <p class="text-sm text-gray-200">${n.message}</p>
                    <p class="text-[10px] text-gray-500 mt-1">${n.created_at}</p>
                  </div>
                `;
        });

        list.innerHTML = html;

        if (hasUnread) dot.classList.remove('hidden');
        else dot.classList.add('hidden');

      } catch (e) { console.error(e); }
    }

    async function markRead(id) {
      try {
        await fetch('/api/mark_notification_read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        });
        fetchNotifications(); // Refresh
      } catch (e) { }
    }

    async function markAllRead() {
      // ideally batch mark, for now just poll
      // Implement batch endpoint if needed, or iterate
    }

    function markSeen() {
      // logic integrated in fetchNotifications
    }

    setInterval(pollState, 5000);
    pollState();

    /* ---------- LEAFLET MAP ---------- */
    /* ---------- LEAFLET MAP ---------- */
    // Initialize map when section is shown or on load (but ideally when shown to handle resizing)
    let mapInstance = null;
    let heatLayer = null;

    function initMap() {
      if (mapInstance) return;
      // Mock coords: 28.6139, 77.2090 (Connaught Place, Delhi) as base
      mapInstance = L.map('officerMap').setView([28.6139, 77.2090], 13);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(mapInstance);

      // Add markers
      L.marker([28.6139, 77.2090]).addTo(mapInstance)
        .bindPopup("<b>HQ</b><br>Command Center").openPopup();

      // Dummy Officers
      const officers = [
        { lat: 28.6129, lng: 77.2100, name: "Officer Alpha" },
        { lat: 28.6149, lng: 77.2080, name: "Officer Bravo" },
        { lat: 28.6150, lng: 77.2110, name: "Officer Charlie" }
      ];

      officers.forEach(off => {
        L.circleMarker([off.lat, off.lng], {
          color: '#13ec5b',
          fillColor: '#13ec5b',
          fillOpacity: 0.5,
          radius: 8
        }).addTo(mapInstance).bindTooltip(off.name);
      });

      // Auto-load heatmap
      setTimeout(toggleHeatmap, 500);
    }

    async function toggleHeatmap() {
      if (!mapInstance) return;

      if (heatLayer) {
        mapInstance.removeLayer(heatLayer);
        heatLayer = null;
        return;
      }

      try {
        const res = await fetch('/api/heatmap_data');
        const points = await res.json();

        // Points format: [lat, lng, intensity]
        heatLayer = L.heatLayer(points, {
          radius: 30, // Increased radius
          blur: 20,
          maxZoom: 17,
          gradient: { 0.2: 'blue', 0.4: 'cyan', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red' } // More vibrant gradient
        }).addTo(mapInstance);

      } catch (e) {
        console.error("Failed to load heatmap data", e);
      }
    }

    // Language Helper
    function setLang(code, name) {
      changeLanguage(code);
      document.getElementById('currentLangLabel').innerText = name;
      // Close dropdown (css group-hover handles it, but creating a cleaner UI might need JS, for now CSS hover is fine as requested "scrolling button")
      // To persist label on load:
      localStorage.setItem('netra_lang_name', name);
    }

    // On load, set label
    window.addEventListener('load', () => {
      const name = localStorage.getItem('netra_lang_name') || 'English';
      const label = document.getElementById('currentLangLabel');
      if (label) label.innerText = name;
    });

    // Hook into showSection to ensuring map renders correctly
    const originalShowSection = showSection;
    showSection = function (id, btn) {
      originalShowSection(id, btn);
      if (id === 'map') {
        setTimeout(() => {
          if (!mapInstance) initMap();
          mapInstance.invalidateSize();
        }, 100);
      }
    }

    // Original script end point - merging with extended functions



    /* --- SOS SYSTEM --- */
    function openSOSModal() {
      document.getElementById('sosModal').classList.remove('hidden');
    }

    function closeSOSModal() {
      document.getElementById('sosModal').classList.add('hidden');
    }

    /* ---------- CREATE CASE ---------- */
    function openCreateCaseModal() {
      document.getElementById('createCaseModal').classList.remove('hidden');
    }

    function closeCreateCaseModal() {
      document.getElementById('createCaseModal').classList.add('hidden');
    }

    async function createCase() {
      const title = document.getElementById('caseTitle').value;
      const desc = document.getElementById('caseDesc').value;

      if (!title) return alert("Title is required");

      try {
        const res = await fetch('/api/create_case', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: title, description: desc })
        });
        const data = await res.json();

        if (data.success) {
          alert("Case created successfully!");
          window.location.reload();
        } else {
          alert("Error: " + data.error);
        }
      } catch (e) {
        console.error(e);
        alert("Server error");
      }
    }

    /* ---------- CASE DETAILS & EVIDENCE ---------- */
    let currentCaseDbId = null; // Store for upload

    async function openCaseDetails(caseId) { // caseId here is case_id string (e.g. NETRA-202X...)
      const modal = document.getElementById('caseDetailsModal');
      modal.classList.remove('hidden');

      // Reset UI
      document.getElementById('cdTitle').innerText = "Loading...";
      document.getElementById('cdDesc').innerText = "...";
      document.getElementById('evidenceListBody').innerHTML = "";
      document.getElementById('noEvidenceMsg').classList.remove('hidden');
      cancelUpload();

      try {
        const res = await fetch(`/api/get_case_details/${caseId}`);
        const data = await res.json();

        if (data.success) {
          const c = data.case;
          currentCaseDbId = c.id; // Store int ID for uploads

          document.getElementById('cdTitle').innerText = `${c.case_id}: ${c.title}`;
          document.getElementById('cdStatus').innerText = `Status: ${c.status} | Officer: ${c.officer_name}`;
          document.getElementById('cdDesc').innerText = c.description || "No description.";

          // Populate Evidence
          const tbody = document.getElementById('evidenceListBody');
          tbody.innerHTML = "";

          if (data.evidence && data.evidence.length > 0) {
            document.getElementById('noEvidenceMsg').classList.add('hidden');
            data.evidence.forEach(e => {
              const row = document.createElement('tr');
              row.className = "border-b border-white/5 hover:bg-white/5";

              // Determine preview link
              // Path in DB is like static/evidence/...
              // Clean up path if needed
              let webPath = e.file_path; // Assuming path stored is relative relative to root or static? 
              // In upload_evidence we stored: static/evidence/...
              // Flask static url needs: /static/evidence/...
              // Ideally use url_for but in JS we construct it.

              const rowHtml = `
                <td class="p-3 text-blue-300 truncate max-w-xs" title="${webPath}">${webPath.split('/').pop()}</td>
                <td class="p-3 uppercase text-xs text-gray-400">${e.file_type}</td>
                <td class="p-3">${e.tags || '-'}</td>
                <td class="p-3">
                  <span class="px-2 py-0.5 rounded text-[10px] border 
                    ${e.status === 'Verified' ? 'border-green-500/30 text-green-400' : 'border-yellow-500/30 text-yellow-400'}">
                    ${e.status}
                  </span>
                </td>
                <td class="p-3 text-gray-500 text-xs">${e.created_at}</td>
                <td class="p-3 flex gap-2">
                  <a href="/${webPath}" target="_blank" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded">View</a>
                  <button onclick="openFeedbackModal(${e.id})" class="text-[10px] text-purple-400 border border-purple-500/30 px-2 py-1 rounded hover:bg-purple-500/10">Rate AI</button>
                </td>
              `;
              row.innerHTML = rowHtml;
              tbody.appendChild(row);
            });
          }
        } else {
          alert("Failed to load case details.");
          closeCaseDetailsModal();
        }
      } catch (e) {
        console.error(e);
        alert("Error loading details");
      }
    }

    function closeCaseDetailsModal() {
      document.getElementById('caseDetailsModal').classList.add('hidden');
    }



    function closeCaseDetailsModal() {
      document.getElementById('caseDetailsModal').classList.add('hidden');
    }

    /* --- UPLOAD LOGIC --- */
    function handleEvidenceSelection(input) {
      if (input.files && input.files[0]) {
        document.getElementById('uploadPreview').classList.remove('hidden');
        document.getElementById('fileName').innerText = input.files[0].name;
      }
    }

    function cancelUpload() {
      document.getElementById('evidenceUpload').value = "";
      document.getElementById('evidenceTags').value = "";
      document.getElementById('uploadPreview').classList.add('hidden');
    }

    async function uploadEvidence() {
      const fileInput = document.getElementById('evidenceUpload');
      const tags = document.getElementById('evidenceTags').value;

      if (!fileInput.files[0]) return;
      if (!currentCaseDbId) return alert("Case ID missing error.");

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      formData.append("case_db_id", currentCaseDbId);
      formData.append("tags", tags);

      const btn = event.target;
      const originalText = btn.innerText;
      btn.innerText = "Uploading...";
      btn.disabled = true;

      try {
        const res = await fetch('/api/upload_evidence', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          alert("Evidence uploaded successfully!");
          closeCaseDetailsModal();
        } else {
          alert("Upload failed: " + data.error);
        }
      } catch (e) {
        console.error(e);
        alert("Server error during upload");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    /* --- AI FEEDBACK --- */
    function openFeedbackModal(evidenceId) {
      document.getElementById('aiFeedbackModal').classList.remove('hidden');
      document.getElementById('feedbackEvidenceId').value = evidenceId;
      document.getElementById('feedbackComment').value = "";
    }

    function closeFeedbackModal() {
      document.getElementById('aiFeedbackModal').classList.add('hidden');
    }

    async function submitFeedback(type) {
      const evidenceId = document.getElementById('feedbackEvidenceId').value;
      const comment = document.getElementById('feedbackComment').value;

      try {
        const res = await fetch('/api/submit_ai_feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            evidence_id: evidenceId,
            feedback: type,
            comments: comment
          })
        });
        const data = await res.json();
        if (data.success) {
          alert("Feedback recorded. Thank you for improving NETRA AI.");
          closeFeedbackModal();
        } else {
          alert("Error: " + data.error);
        }
      } catch (e) {
        console.error(e);
      }
    }


    function cancelUpload() {
      document.getElementById('evidenceUpload').value = "";
      document.getElementById('evidenceTags').value = "";
      document.getElementById('uploadPreview').classList.add('hidden');
    }

    async function uploadEvidence() {
      const fileInput = document.getElementById('evidenceUpload');
      const tags = document.getElementById('evidenceTags').value;

      if (!fileInput.files[0]) return;
      if (!currentCaseDbId) return alert("Case ID missing error.");

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      formData.append("case_db_id", currentCaseDbId);
      formData.append("tags", tags);

      const btn = event.target;
      const originalText = btn.innerText;
      btn.innerText = "Uploading...";
      btn.disabled = true;

      try {
        const res = await fetch('/api/upload_evidence', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          // Refresh details
          // We need the string case ID to re-call openCaseDetails or just reload. 
          // Since openCaseDetails uses string ID and we only have int ID here easily 
          // (Wait, we do have string ID in the title but easier to just reload page or fetch specific evidence row).
          // Simplest: Close and Alert
          alert("Evidence uploaded successfully!");
          closeCaseDetailsModal();
          // Or ideally: Reload the modal content.
        } else {
          alert("Upload failed: " + data.error);
        }
      } catch (e) {
        console.error(e);
        alert("Server error during upload");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    function triggerSOS(type) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const { latitude, longitude } = position.coords;
          sendSOSAlert(type, latitude, longitude);
        }, error => {
          console.error("Geo Error:", error);
          // Send without location if blocked/error
          sendSOSAlert(type, null, null);
          alert("Location access denied. Sending alert without coordinates.");
        });
      } else {
        sendSOSAlert(type, null, null);
        alert("Geolocation not supported. Sending alert without coordinates.");
      }
      closeSOSModal();
    }

    async function sendSOSAlert(type, lat, lng) {
      try {
        await fetch('/api/sos_alert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, lat, lng })
        });
        alert("üö® SOS SIGNAL SENT! Help is on the way.");
        loadActivityLogs(); // Log this action
      } catch (e) {
        console.error(e);
        alert("Failed to send SOS! Please try again or call manually.");
      }
    }

    /* --- QUICK ACTIONS --- */
    async function triggerAction(type) {
      if (!confirm(`Are you sure you want to trigger: ${type.toUpperCase()}?`)) return;

      try {
        const res = await fetch('/api/quick_action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: type })
        });
        const data = await res.json();

        if (data.success) {
          // Custom "Toast" or just a better alert for now
          // Using a mock-toast by reusing an element or simple alert
          alert(`‚úÖ ACTION CONFIRMED\n\n${data.message}\n\nAlert sent to all field officers.`);
          loadActivityLogs();
        } else {
          alert("Action Failed: " + data.error);
        }
      } catch (e) {
        console.error(e);
        alert("Server Error");
      }
    }

    /* --- ACTIVITY LOGS --- */
    async function loadActivityLogs() {
      const container = document.getElementById('activityLogContainer');
      container.innerHTML = '<p class="text-gray-500 italic text-center py-4">Loading operational logs...</p>';

      try {
        const res = await fetch('/api/officer_activity');
        const logs = await res.json();

        if (logs.length === 0) {
          container.innerHTML = '<p class="text-gray-500 italic text-center py-4">No recent activity recorded.</p>';
          return;
        }

        let html = '';
        logs.forEach(log => {
          const icon = log.type === 'alert' ? 'üõë' : (log.type === 'message' ? 'üí¨' : 'üìù');
          html += `
  <div class="glass p-3 rounded flex items-start gap-3 hover:bg-white/5 transition">
    <div class="text-xl mt-1">${icon}</div>
    <div>
      <p class="text-gray-200 text-sm font-semibold">${log.action}</p>
      <p class="text-xs text-gray-500 font-mono mt-1">${log.timestamp}</p>
      ${log.details ? `<p class="text-xs text-gray-400 mt-1 italic">${log.details}</p>` : ''}
    </div>
  </div>
  `;
        });
        container.innerHTML = html;
      } catch (e) {
        console.error(e);
        container.innerHTML = '<p class="text-red-400 italic text-center py-4">Error loading logs.</p>';
      }
    }

    /* --- SUSPECT SEARCH --- */
    async function searchSuspects() {
      const query = document.getElementById('suspectQuery').value;
      const container = document.getElementById('searchResults');

      if (!query) return alert("Enter a description to search.");

      container.classList.remove('hidden');
      container.innerHTML = '<p class="text-gray-400 col-span-full text-center py-4">Scanning active feeds...</p>';

      try {
        const res = await fetch('/api/search_suspects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const results = await res.json();

        if (results.length === 0) {
          container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">No matches found in last 30 minutes.</p>';
          return;
        }

        container.innerHTML = results.map(r => `
                <div class="bg-black/50 border border-white/10 rounded overflow-hidden hover:border-blue-500 transition cursor-pointer" onclick="openChallanModal(); document.getElementById('challanName').value='${r.desc}'">
                    <img src="${r.img}" class="w-full h-32 object-cover opacity-80 hover:opacity-100">
                    <div class="p-2">
                        <p class="text-xs font-bold text-blue-300">${r.cam}</p>
                        <p class="text-xs text-gray-400">${r.time}</p>
                        <p class="text-sm font-semibold text-white mt-1">${r.desc}</p>
                    </div>
                </div>
            `).join('');

      } catch (e) { console.error(e); }
    }

    /* --- CROWD DENSITY --- */
    async function pollCrowdDensity() {
      const container = document.getElementById('crowdContainer');
      if (!container) return;

      try {
        const res = await fetch('/api/crowd_status');
        const data = await res.json();

        if (!data || data.length === 0) return;

        container.innerHTML = data.map(sec => {
          let color = 'bg-green-500';
          let textColor = 'text-green-400';

          if (sec.density > 85) { color = 'bg-red-600'; textColor = 'text-red-500'; }
          else if (sec.density > 70) { color = 'bg-orange-500'; textColor = 'text-orange-400'; }
          else if (sec.density > 40) { color = 'bg-yellow-500'; textColor = 'text-yellow-400'; }

          return `
                  <div class="glass p-4 rounded border border-white/5 relative overflow-hidden group">
                     <div class="flex justify-between items-end mb-2 relative z-10">
                        <span class="text-xs text-gray-400 uppercase font-bold tracking-wider">${sec.name}</span>
                        <span class="text-xl font-bold ${textColor}">${sec.percent}%</span>
                     </div>
                     <div class="text-3xl font-bold text-white mb-1 relative z-10">${sec.density}%</div>
                     <p class="text-xs ${textColor} font-mono relative z-10">${sec.status}</p>
                     
                     <!-- Bar BG -->
                     <div class="absolute bottom-0 left-0 h-1 ${color} transition-all duration-1000" style="width: ${sec.density}%"></div>
                     <div class="absolute inset-0 ${color} opacity-5 group-hover:opacity-10 transition duration-500"></div>
                  </div>
                `;
        }).join('');

      } catch (e) { console.error("Crowd Poll Error", e); }
    }

    // Poll every 3 seconds for crowd updates
    setInterval(pollCrowdDensity, 3000);
    pollCrowdDensity();

    /* --- SEARCH & FILTER --- */
    function filterRecords() {
      const query = document.getElementById('recordSearch').value.toLowerCase();
      const statusFilter = document.getElementById('recordFilter').value;
      const rows = document.querySelectorAll('.record-row');

      rows.forEach(row => {
        const content = row.getAttribute('data-content').toLowerCase();
        const status = row.getAttribute('data-status');

        const matchesSearch = content.includes(query);
        const matchesStatus = (statusFilter === 'all') ||
          (statusFilter === 'resolved' && status === 'Resolved') ||
          (statusFilter === 'unresolved' && status !== 'Resolved');

        if (matchesSearch && matchesStatus) {
          row.classList.remove('hidden');
        } else {
          row.classList.add('hidden');
        }
      });
    }

    /* ---------- AI REVIEWS ---------- */
    async function loadReviews() {
      const container = document.getElementById('reviewContainer');
      container.innerHTML = '<p class="text-gray-500 italic">Loading...</p>';

      try {
        const res = await fetch('/api/get_pending_reviews');
        const reviews = await res.json();

        if (reviews.length === 0) {
          container.innerHTML = '<p class="text-gray-500 italic">No pending reviews.</p>';
          return;
        }

        container.innerHTML = reviews.map(r => `
                <div class="bg-black/40 border border-orange-500/30 rounded-xl overflow-hidden shadow-lg">
                    <div class="relative h-48">
                        <img src="/${r.file_path}" class="w-full h-full object-cover opacity-80" alt="Evidence">
                        <div class="absolute top-2 right-2 bg-black/70 px-2 py-1 rounded text-xs text-orange-400 font-mono border border-orange-500/50">
                            ${Math.round(r.confidence_score * 100)}% Conf.
                        </div>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-white mb-1">${r.tags}</h4>
                        <p class="text-xs text-gray-400 mb-2">Zone: <span class="text-gray-200">${r.zone_name || 'N/A'}</span></p>
                        <p class="text-xs text-gray-500 font-mono mb-4">${r.created_at}</p>
                        
                        <div class="flex gap-2">
                             <button onclick="confirmViolation(${r.id})" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded text-xs font-bold transition">
                                Confirm & Fine
                             </button>
                             <button onclick="dismissViolation(${r.id})" class="flex-1 bg-white/10 hover:bg-white/20 text-gray-300 py-2 rounded text-xs transition">
                                Dismiss
                             </button>
                        </div>
                    </div>
                </div>
            `).join('');

      } catch (e) { console.error(e); }
    }

    async function confirmViolation(id) {
      if (!confirm("Confirm this violation?")) return;

      try {
        const res = await fetch('/api/confirm_violation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, remarks: "Confirmed by Officer via Dashboard" })
        });
        const data = await res.json();
        if (data.success) {
          alert("Violation Confirmed! Opening Challan Form...");
          loadReviews();

          openChallanModal();
          document.getElementById('challanName').value = "Unknown (Auto-Detect)";
          document.getElementById('challanReason').value = "Trespassing";
          // In a real app, we'd pass the evidence ID to the challan submission
          document.getElementById('challanResult').innerText = `Linked Evidence ID: ${id}`;
          document.getElementById('challanResult').classList.remove('hidden');
        } else {
          alert("Error: " + data.error);
        }
      } catch (e) { alert("Server Error"); }
    }

    async function dismissViolation(id) {
      if (!confirm("Dismiss as false positive?")) return;
      try {
        await fetch('/api/dismiss_violation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        loadReviews();
      } catch (e) { }
    }

    /* --- NAVIGATION --- */
    function navigateToAlert(message) {
      // Regex to find "Location lat, lng" pattern
      // Matches "Location 28.123, 77.456" or similar
      const coordRegex = /Location\s*([\d\.]+),\s*([\d\.]+)/i;
      const match = message.match(coordRegex);

      if (match) {
        const lat = match[1];
        const lng = match[2];
        const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        window.open(url, '_blank');
      } else {
        // Fallback: If no coords found, search the message text or just open maps
        // Searching message text might yield results if it contains a place name
        const encodedMsg = encodeURIComponent(message);
        const url = `https://www.google.com/maps/search/?api=1&query=${encodedMsg}`;

        if (confirm(`No precise coordinates found in alert. Search Google Maps for "${message}"?`)) {
          window.open(url, '_blank');
        }
      }
    }

  </script>

  <script src="{{ url_for('static', filename='js/translations.js') }}"></script>
</body>

</html>