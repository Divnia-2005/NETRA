<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Officer Dashboard â€” NETRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js" crossorigin=""></script>
  <!-- Google Fonts: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Outfit', sans-serif;
    }

    .glass {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .gradient-text {
      background: linear-gradient(to right, #4ade80, #22d3ee);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .cam-feed {
      background-color: #000;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cam-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: rgba(0, 255, 0, 0.8);
      font-family: monospace;
      font-size: 0.75rem;
      z-index: 400;
      /* Leaflet uses high z-indices, be careful if map overlaps, but here they are separate */
      text-shadow: 0 0 2px black;
    }

    .rec-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: sans-serif;
      font-size: 0.7rem;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 10;
    }

    .rec-dot {
      width: 8px;
      height: 8px;
      background-color: red;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }

      100% {
        opacity: 1;
      }
    }

    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(0, 255, 100, 0.3);
      box-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
      animation: scan 4s linear infinite;
      opacity: 0.5;
      z-index: 5;
    }

    @keyframes scan {
      0% {
        top: -10%;
      }

      100% {
        top: 110%;
      }
    }

    .bg-sidebar {
      background-color: rgba(17, 34, 23, 0.8);
      backdrop-filter: blur(5px);
    }

    .accent {
      color: #13ec5b;
    }

    .nav-btn {
      display: block;
      padding: 12px;
      border-radius: 8px;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .nav-btn:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: #13ec5b;
      transform: translateX(4px);
    }

    .nav-btn.active {
      background-color: rgba(19, 236, 91, 0.1);
      color: #13ec5b;
      border-left: 3px solid #13ec5b;
    }

    .lang-opt {
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      font-size: 0.75rem;
      color: #d1d5db;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .lang-opt:hover {
      background-color: rgba(19, 236, 91, 0.2);
      color: #13ec5b;
    }
  </style>
</head>

<body
  class="bg-[#050b07] bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-[#0f2818] via-[#050b07] to-black text-white h-screen flex overflow-hidden">
  <!-- TOP NAVBAR -->
  <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm">
  </div>

  <header class="fixed top-0 left-0 right-0 z-50 h-14
               flex items-center gap-4
               bg-[#102216] border-b border-green-900 px-4">

    <!-- Hamburger -->
    <button onclick="toggleSidebar()" class="text-[#13ec5b] focus:outline-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"
        stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>

    <span class="font-bold text-[#13ec5b] text-lg flex-1">
      NETRA Officer
    </span>

    <!-- Language Selector -->
    <!-- Custom Language Selector -->
    <div class="relative mr-4 group z-50">
      <button id="langBtn"
        class="flex items-center gap-2 bg-[#102216] text-[#13ec5b] border border-[#13ec5b] text-xs rounded px-3 py-1.5 focus:outline-none hover:bg-[#13ec5b]/10 transition">
        <span id="currentLangLabel">Language</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <!-- Dropdown Menu -->
      <div class="absolute right-0 top-full pt-1 w-40 hidden group-hover:block z-50">
        <div class="bg-[#0a160f] border border-[#13ec5b]/30 rounded-lg shadow-xl overflow-hidden">
          <div class="max-h-60 overflow-y-auto custom-scrollbar-chat p-1 space-y-1">
            <button onclick="setLang('en', 'English')" class="lang-opt">English</button>
            <button onclick="setLang('hi', 'Hindi')" class="lang-opt">Hindi</button>
            <button onclick="setLang('ml', 'Malayalam')" class="lang-opt">Malayalam</button>
            <button onclick="setLang('fr', 'French')" class="lang-opt">French</button>
            <button onclick="setLang('es', 'Spanish')" class="lang-opt">Spanish</button>
            <button onclick="setLang('zh', 'Chinese')" class="lang-opt">Chinese</button>
            <button onclick="setLang('de', 'German')" class="lang-opt">German</button>
            <button onclick="setLang('ja', 'Japanese')" class="lang-opt">Japanese</button>
            <button onclick="setLang('ru', 'Russian')" class="lang-opt">Russian</button>
            <button onclick="setLang('ar', 'Arabic')" class="lang-opt">Arabic</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Bell -->
    <div class="relative mr-4 cursor-pointer"
      onclick="markSeen(); showSection('messages', document.querySelector('[onclick*=\'messages\']'));">
      <svg id="notificationBell" xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 text-gray-400 transition-colors duration-300" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <!-- Red Dot -->
      <span id="notificationDot"
        class="hidden absolute top-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-[#102216] bg-red-500"></span>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="fixed top-0 left-0 z-50 w-64 h-full
         bg-sidebar p-4 space-y-6
         transform -translate-x-full
         transition-transform duration-300 overflow-y-auto">


    <div>
      <h2 class="text-xl font-bold accent mb-6">NETRA Officer</h2>
      <!-- OFFICER PROFILE CARD -->
      <div class="flex items-center gap-3 glass p-3 rounded mb-4">
        <img id="officerPic" src="https://via.placeholder.com/60"
          class="w-14 h-14 rounded-full object-cover border border-green-400">
        <div>
          <p id="officerName" class="font-semibold">{{ session.user.name }}</p>
          <p class="text-xs text-green-300">Security Officer</p>
        </div>
      </div>


      <nav class="space-y-2">
        <button class="nav-btn active" onclick="showSection('dashboard', this)" data-i18n="dashboard">Dashboard</button>
        <button class="nav-btn" onclick="showSection('map', this)" data-i18n="tactical_map">Tactical Map</button>
        <button class="nav-btn" onclick="showSection('alerts', this)" data-i18n="alerts">System Alerts</button>
        <button class="nav-btn" onclick="showSection('analysis', this)" data-i18n="analysis">Analysis</button>
        <button class="nav-btn" onclick="showSection('reports', this)" data-i18n="reports">Reports</button>
        <button class="nav-btn" onclick="showSection('messages', this)" data-i18n="messages">Messages</button>
        <button class="nav-btn" onclick="showSection('settings', this)" data-i18n="settings">Settings</button>
      </nav>
    </div>
    <button class="nav-btn" onclick="showSection('profile', this)" data-i18n="profile">
      Profile
    </button>

    <a href="/logout" data-i18n="logout"
      class="block w-full text-left p-3 mt-8 bg-red-900/30 text-red-400 rounded hover:bg-red-900/50 hover:text-red-300 font-bold transition-colors">
      Logout
    </a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-6 overflow-y-auto pt-16">

    <!-- DASHBOARD -->
    <section id="dashboard" class="section">
      <h1 class="text-3xl font-bold mb-1 tracking-tight"><span data-i18n="command_center">Command Center</span></h1>
      <p class="text-sm text-[#a7f3d0] mb-6">System Online</p>

      <!-- QUICK ACTIONS -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <button
          class="bg-red-600/20 text-red-400 border border-red-600 px-4 py-3 rounded hover:bg-red-600 hover:text-white"
          data-i18n="trigger_alarm">Trigger
          Alarm</button>
        <button
          class="bg-yellow-500/20 text-yellow-400 border border-yellow-500 px-4 py-3 rounded hover:bg-yellow-500 hover:text-black"
          data-i18n="spotlight">Spotlight</button>
        <button class="glass border border-[#13ec5b]/30 px-4 py-3 rounded hover:bg-[#1f3b2b]"
          data-i18n="broadcast">Broadcast</button>
        <button class="glass border border-[#13ec5b]/30 px-4 py-3 rounded hover:bg-[#1f3b2b]"
          data-i18n="unlock_gates">Unlock Gates</button>
      </div>

      <!-- LIVE FEEDS -->
      <h2 class="text-xl font-bold mb-4" data-i18n="live_surveillance">Live Surveillance</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Cam 1 -->
        <div class="cam-feed rounded-xl h-48 relative group">
          <div class="cam-overlay">CAM-01 [GATE]</div>
          <div class="rec-indicator">
            <div class="rec-dot"></div> LIVE
          </div>
          <div class="scan-line"></div>
          <img src="https://images.unsplash.com/photo-1541888946425-d81bb19240f5?q=80&w=600&auto=format&fit=crop"
            class="w-full h-full object-cover opacity-60">
        </div>
        <!-- Cam 2 -->
        <div class="cam-feed rounded-xl h-48 relative group">
          <div class="cam-overlay">CAM-02 [LOBBY]</div>
          <div class="rec-indicator">
            <div class="rec-dot"></div> LIVE
          </div>
          <div class="scan-line" style="animation-delay: 1.5s;"></div>
          <img src="https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=600&auto=format&fit=crop"
            class="w-full h-full object-cover opacity-60">
        </div>
      </div>
    </section>

    <!-- RECORD CONSOLE (Dynamic) -->
    <section id="alerts" class="section hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Records Console</h2>
        <div class="flex gap-2">
          <input type="text" id="recordSearch" onkeyup="filterRecords()" placeholder="Search keywords..."
            class="glass text-white px-3 py-1 rounded border border-green-800 text-sm">
          <select id="recordFilter" onchange="filterRecords()"
            class="glass text-white px-3 py-1 rounded border border-green-800 text-sm">
            <option value="all">All Status</option>
            <option value="unresolved">Unresolved</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
      </div>

      <div class="glass rounded-xl overflow-x-auto border border-white/5">
        <table class="w-full text-sm text-left">
          <thead class="text-xs uppercase bg-white/5 text-gray-400 border-b border-white/5">
            <tr>
              <th class="px-4 py-3">ID</th>
              <th class="px-4 py-3">Time</th>
              <th class="px-4 py-3">Source</th>
              <th class="px-4 py-3">Message</th>
              <th class="px-4 py-3">Severity</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Action</th>
            </tr>
          </thead>
          <tbody id="recordsTableBody" class="divide-y divide-white/5">
            {% for alert in alerts %}
            <tr class="record-row hover:bg-white/5 transition duration-150"
              data-content="{{ alert.message|e }} {{ alert.source|e }} {{ alert.id }}" data-status="{{ alert.status }}">
              <td class="px-4 py-3 font-mono text-emerald-400">#{{ alert.id }}</td>
              <td class="px-4 py-3 text-gray-400">{{ alert.created_at }}</td>
              <td class="px-4 py-3 font-bold text-gray-200">{{ alert.source }}</td>
              <td class="px-4 py-3 text-gray-300">{{ alert.message }}</td>
              <td class="px-4 py-3">
                {% if alert.severity == 'Critical' %}
                <span
                  class="bg-red-500/20 text-red-300 py-1 px-2 rounded text-xs font-bold border border-red-500/20 shadow-[0_0_10px_rgba(239,68,68,0.2)]">CRITICAL</span>
                {% elif alert.severity == 'Warning' %}
                <span
                  class="bg-yellow-500/20 text-yellow-300 py-1 px-2 rounded text-xs font-bold border border-yellow-500/20">WARNING</span>
                {% else %}
                <span
                  class="bg-green-500/20 text-green-300 py-1 px-2 rounded text-xs font-bold border border-green-500/20">INFO</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                <span id="status-{{alert.id}}"
                  class="py-1 px-2 rounded text-xs font-bold {{ 'bg-green-500/20 text-green-400 border border-green-500/20' if alert.status =='Resolved' else 'bg-red-500/20 text-red-400 border border-red-500/20' }}">
                  {{ alert.status }}
                </span>
              </td>
              <td class="px-4 py-3">
                {% if alert.status != 'Resolved' %}
                <button onclick="updateStatus('{{ alert.id }}', 'Resolved')"
                  class="bg-[#13ec5b] text-black px-2 py-1 rounded text-xs hover:bg-green-400 font-bold shadow-lg shadow-green-500/20">Resolve</button>
                {% else %}
                <span class="text-gray-600 text-xs">No Action</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            {% if not alerts %}
            <tr>
              <td colspan="7" class="px-4 py-6 text-center text-gray-500 italic">No records found using current
                connection.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- ANALYSIS -->
    <section id="analysis" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Data Analysis</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-4 rounded">
          <h3 class="font-bold mb-4 text-sm text-gray-400">Alert Severity Distribution</h3>
          <div class="h-64">
            <canvas id="severityChart"></canvas>
          </div>
        </div>
        <div class="glass p-4 rounded flex flex-col justify-center">
          <div class="text-center mb-6">
            <p class="text-4xl font-bold text-[#13ec5b] mb-1">{{ alerts|length }}</p>
            <p class="text-sm text-gray-400">Total Records</p>
          </div>
          <div class="text-center">
            <p class="text-4xl font-bold text-yellow-400 mb-1">
              {% set ns = namespace(pending=0) %}
              {% for a in alerts if a.status != 'Resolved' %}{% set ns.pending = ns.pending + 1 %}{% endfor %}
              {{ ns.pending }}
            </p>
            <p class="text-sm text-gray-400">Pending Actions</p>
          </div>
        </div>
      </div>
    </section>

    <!-- MAP VIEW -->
    <section id="map" class="section hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" data-i18n="tactical_map">Tactical Map</h2>
        <button onclick="toggleHeatmap()" data-i18n="toggle_heatmap"
          class="bg-[#13ec5b]/20 text-[#13ec5b] px-3 py-1 rounded border border-[#13ec5b] hover:bg-[#13ec5b] hover:text-black transition text-sm font-bold">
          Toggle Heatmap
        </button>
      </div>
      <div class="glass p-2 rounded-xl">
        <div id="officerMap" class="h-96 w-full rounded-lg z-0"></div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Reports</h2>
      <div class="glass p-4 rounded flex justify-between items-center">
        <div>
          <h3 class="font-bold text-lg">Download Reports</h3>
          <p class="text-sm text-gray-400">Export incident logs and alerts to Excel.</p>
        </div>
        <a href="/export_reports" class="bg-[#13ec5b] text-black px-4 py-2 rounded hover:bg-green-400 font-bold">
          Export to Excel
        </a>
      </div>
    </section>

    <!-- MESSAGES -->
    <section id="messages" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Messages</h2>
      <div class="glass p-6 rounded-xl border border-white/5 mb-6">
        <h3 class="panel-title mb-4 font-bold text-emerald-400">Comms with HQ</h3>

        <!-- Compose -->
        <div class="mb-4 space-y-2">
          <div class="flex gap-2">
            <select id="msgRecipient"
              class="glass p-2 rounded text-sm border-white/10 w-1/3 text-gray-300 focus:outline-none focus:border-green-500">
              <option value="" disabled selected class="bg-black">Select Recipient...</option>
              {% for user in recipients %}
              <option value="{{ user.id }}"
                class="bg-black {{ 'font-bold text-green-400' if user.role == 'admin' else '' }}">
                {{ user.name }} ({{ user.role|capitalize }})
              </option>
              {% endfor %}
            </select>

            <input id="msgContent" type="text" placeholder="Type a message..."
              class="glass p-2 rounded text-sm border-white/10 w-full text-white placeholder-gray-500 focus:outline-none focus:border-green-500">
            <button onclick="sendMessage()"
              class="bg-gradient-to-r from-green-500 to-emerald-600 text-black px-4 py-2 rounded hover:from-green-400 hover:to-emerald-500 font-bold shadow-lg shadow-green-500/20 transition-all duration-300">
              Send
            </button>
          </div>
        </div>

        <!-- Log -->
        <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Inbox / Sent</h4>
        <div class="h-[400px] overflow-y-auto space-y-3 custom-scrollbar pr-2">
          {% for msg in messages %}
          <div
            class="p-3 rounded-lg text-sm shadow-sm {{ 'bg-emerald-900/20 ml-12 border-l-2 border-emerald-500 self-end text-right' if msg.sender_id == session.user.id else 'bg-white/5 mr-12 border-r-2 border-gray-600' }}">
            <div
              class="flex justify-between text-xs text-gray-500 mb-1 {{ 'flex-row-reverse' if msg.sender_id == session.user.id }}">
              <span class="font-bold text-gray-400">
                {% if msg.sender_id == session.user.id %}
                You âž” Admin
                {% else %}
                {{ msg.sender_name }} âž” You
                {% endif %}
              </span>
              <span>{{ msg.timestamp }}</span>
            </div>
            <p class="text-gray-200">{{ msg.content }}</p>
          </div>
          {% endfor %}
          {% if not messages %}
          <div class="flex flex-col items-center justify-center h-full text-gray-500 space-y-2">
            <span class="text-2xl opacity-20">ðŸ’¬</span>
            <p class="text-xs italic">No messages.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="section hidden">
      <h2 class="text-xl font-bold mb-4">Settings</h2>
      <div class="glass p-6 rounded-xl max-w-lg">
        <label class="block mb-4">
          Alert Volume
          <input type="range" class="w-full mt-2 accent-green-500">
        </label>
        <button
          class="bg-[#13ec5b] text-black px-6 py-2 rounded hover:bg-green-400 font-bold shadow-lg shadow-green-500/20">
          Save Settings
        </button>
      </div>
    </section>



    <!-- PROFILE -->
    <section id="profile" class="section hidden flex justify-center">
      <div class="glass p-8 rounded-2xl max-w-lg w-full relative overflow-hidden">
        <!-- Decoration -->
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-500/20 rounded-full blur-3xl pointer-events-none">
        </div>

        <h2 class="text-xl font-bold mb-6 text-center">Officer Profile</h2>

        <!-- Profile Picture -->
        <div class="flex flex-col items-center gap-4 mb-6">
          <div class="relative group">
            <img id="officerPicPreview" src="https://via.placeholder.com/120"
              class="w-28 h-28 rounded-full object-cover border-4 border-white/5 group-hover:border-green-400 transition-all duration-300 shadow-xl">
            <div
              class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none">
              <span class="text-xs font-bold text-white">Change</span>
            </div>
          </div>
          <input type="file" accept="image/*" onchange="updateOfficerPic(event)"
            class="text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-500/10 file:text-green-400 hover:file:bg-green-500/20">
        </div>

        <!-- Profile Fields -->
        <div class="space-y-4">
          <div>
            <label class="text-sm text-gray-400 ml-1">Username (Email)</label>
            <input id="officerUsername" class="w-full glass p-3 rounded-lg text-white" value="{{ session.user.email }}"
              readonly>
          </div>

          <div>
            <label class="text-sm text-gray-400 ml-1">Full Name</label>
            <input id="officerProfileName" class="w-full glass p-3 rounded-lg text-white"
              value="{{ session.user.name }}" readonly>
          </div>

          <div>
            <label class="text-sm text-gray-400 ml-1">Role</label>
            <input class="w-full glass p-3 rounded-lg text-gray-400" value="{{ session.user.role|capitalize }}"
              disabled>
          </div>

          <!-- Save button removed as it only saved to local storage incorrectly -->
          <!-- Re-enabling for visual completeness even if backend logic is stubbed in this context -->
          <button onclick="saveOfficerProfile()"
            class="bg-gradient-to-r from-green-600 to-emerald-700 text-white p-3 rounded-lg w-full font-bold hover:shadow-lg hover:shadow-green-500/20 hover:scale-[1.02] transition-all duration-300 mt-4">
            Save Profile
          </button>
        </div>
      </div>
    </section>

    {% include 'component_chatbot.html' %}
  </main>

  <!-- JS -->
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");

      sidebar.classList.toggle("-translate-x-full");
      overlay.classList.toggle("hidden");
    }

    /* Close sidebar after clicking any menu item */
    /* Event Listeners replaced by direct call in showSection to handle mobile check */
    /* ---------- SECTION SWITCHING ---------- */
    function showSection(id, btn) {
      document.querySelectorAll('.section').forEach(sec => {
        sec.classList.add('hidden');
      });

      const target = document.getElementById(id);
      if (target) target.classList.remove('hidden');

      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('active');
      });
      if (btn) btn.classList.add('active');

      // Trigger chart resize if analysis section is shown
      if (id === 'analysis' && window.myChart) {
        window.myChart.resize();
      }

      // Auto-hide sidebar on mobile
      // Auto-hide sidebar
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      if (sidebar && !sidebar.classList.contains("-translate-x-full")) {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
      }
    }

    function updateOfficerPic(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        localStorage.setItem("officerPic", reader.result);
        document.getElementById("officerPic").src = reader.result;
        document.getElementById("officerPicPreview").src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    async function saveOfficerProfile() {
      const name = document.getElementById("officerNameInput").value;
      if (!name) return alert("Name is required");

      try {
        const res = await fetch('/api/update_profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        });
        const data = await res.json();
        if (data.success) {
          alert("Profile saved successfully!");
          document.getElementById("officerName").innerText = name; // Update sidebar
        } else {
          alert("Error: " + data.error);
        }
      } catch (e) { console.error(e); alert("Server error"); }
    }

    /* LOAD OFFICER PROFILE DATA */
    window.addEventListener("load", () => {
      // Only load picture from local storage if needed. 
      // Text fields are now populated by server session data.
      if (localStorage.getItem("officerPic")) {
        const pic = localStorage.getItem("officerPic");
        const el1 = document.getElementById("officerPic");
        const el2 = document.getElementById("officerPicPreview");
        if (el1) el1.src = pic;
        if (el2) el2.src = pic;
      }

      initChart();
    });

    /* ---------- SEARCH & FILTER ---------- */
    console.log("Dashboard Script Loaded");
    function filterRecords() {
      const query = document.getElementById('recordSearch').value.toLowerCase();
      const statusFilter = document.getElementById('recordFilter').value.toLowerCase();
      const rows = document.querySelectorAll('.record-row');

      rows.forEach(row => {
        const content = row.getAttribute('data-content').toLowerCase();
        const status = row.getAttribute('data-status').toLowerCase();

        const matchesSearch = content.includes(query);
        const matchesStatus = (statusFilter === 'all') || (status === statusFilter);

        if (matchesSearch && matchesStatus) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    /* ---------- UPDATE STATUS ---------- */
    async function updateStatus(id, newStatus) {
      if (!confirm("Mark this record as Resolved?")) return;

      try {
        const res = await fetch('/api/update_alert_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, status: newStatus })
        });
        const data = await res.json();

        if (data.success) {
          // Update UI without reload
          const statusBadge = document.getElementById(`status-${id}`);
          if (statusBadge) {
            statusBadge.innerText = newStatus;
            statusBadge.className = "py-1 px-2 rounded text-xs font-bold bg-green-500/20 text-green-400";
          }
          // Update data attribute for filter
          const row = statusBadge.closest('tr');
          if (row) row.setAttribute('data-status', newStatus);

          // Recalculate pending count (simple reload for now or sophisticated DOM update)
          // For simplicity, just alert
          // alert("Status updated!");
        } else {
          alert("Failed to update status: " + data.error);
        }
      } catch (e) {
        console.error(e);
        alert("Error updating status");
      }
    }

    async function sendMessage() {
      // Get Recipient ID from dropdown
      const recipient = document.getElementById('msgRecipient').value;
      const content = document.getElementById('msgContent').value;

      if (!recipient) return alert("Please select a recipient.");
      if (!content.trim()) return alert("Please enter a message.");

      try {
        const res = await fetch('/api/send_message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ receiver_id: recipient, content: content })
        });
        const data = await res.json();
        if (data.success) {
          window.location.reload();
        } else {
          alert("Error: " + data.error);
        }
      } catch (err) {
        console.error(err);
        alert("Failed to send message.");
      }
    }

    /* ---------- CHART.JS ---------- */
    function initChart() {
      const ctx = document.getElementById('severityChart');
      if (!ctx) return;

      // Count severities from table (or jinja injected)
      // We will parse the rows to be dynamic
      let high = 0, med = 0, low = 0;
      document.querySelectorAll('.record-row').forEach(row => {
        const html = row.innerHTML;
        if (html.includes('CRITICAL')) high++;
        else if (html.includes('WARNING')) med++;
        else low++;
      });

      window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Critical', 'Warning', 'Info'],
          datasets: [{
            data: [high, med, low],
            backgroundColor: ['#ef4444', '#facc15', '#22c55e'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#fff' }
            }
          }
        }
      });
    }

    /* ---------- POLLING & NOTIFICATIONS ---------- */
    let lastMsgId = 0;
    let lastAlertId = 0;
    let serverMaxMsgId = 0;

    async function pollState() {
      try {
        const res = await fetch('/api/sync_state');
        if (!res.ok) return;
        const data = await res.json();

        serverMaxMsgId = data.latest_msg_id;

        // On first run, valid IDs -> set baseline
        if (lastMsgId === 0) {
          lastMsgId = data.latest_msg_id;
          // Also set alert baseline if we track it?
          // Officer dashboard mainly uses messages for notifications in this snippet for now
          // but let's be robust
          return;
        }

        const dot = document.getElementById('notificationDot');
        // Check for updates
        if (dot && data.latest_msg_id > lastMsgId) {
          dot.classList.remove('hidden');
        }
      } catch (e) { console.error("Poll error", e); }
    }

    function markSeen() {
      const dot = document.getElementById('notificationDot');
      if (dot) dot.classList.add('hidden');
      if (serverMaxMsgId > 0) lastMsgId = serverMaxMsgId;
    }

    setInterval(pollState, 5000);
    pollState();

    /* ---------- LEAFLET MAP ---------- */
    // Initialize map when section is shown or on load (but ideally when shown to handle resizing)
    // We'll init global variable and resize on show
    /* ---------- LEAFLET MAP ---------- */
    // Initialize map when section is shown or on load (but ideally when shown to handle resizing)
    let mapInstance = null;
    let heatLayer = null;

    function initMap() {
      if (mapInstance) return;
      // Mock coords: 28.6139, 77.2090 (Connaught Place, Delhi) as base
      mapInstance = L.map('officerMap').setView([28.6139, 77.2090], 13);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(mapInstance);

      // Add markers
      L.marker([28.6139, 77.2090]).addTo(mapInstance)
        .bindPopup("<b>HQ</b><br>Command Center").openPopup();

      // Dummy Officers
      const officers = [
        { lat: 28.6129, lng: 77.2100, name: "Officer Alpha" },
        { lat: 28.6149, lng: 77.2080, name: "Officer Bravo" },
        { lat: 28.6150, lng: 77.2110, name: "Officer Charlie" }
      ];

      officers.forEach(off => {
        L.circleMarker([off.lat, off.lng], {
          color: '#13ec5b',
          fillColor: '#13ec5b',
          fillOpacity: 0.5,
          radius: 8
        }).addTo(mapInstance).bindTooltip(off.name);
      });

      // Auto-load heatmap
      setTimeout(toggleHeatmap, 500);
    }

    async function toggleHeatmap() {
      if (!mapInstance) return;

      if (heatLayer) {
        mapInstance.removeLayer(heatLayer);
        heatLayer = null;
        return;
      }

      try {
        const res = await fetch('/api/heatmap_data');
        const points = await res.json();

        // Points format: [lat, lng, intensity]
        heatLayer = L.heatLayer(points, {
          radius: 30, // Increased radius
          blur: 20,
          maxZoom: 17,
          gradient: { 0.2: 'blue', 0.4: 'cyan', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red' } // More vibrant gradient
        }).addTo(mapInstance);

      } catch (e) {
        console.error("Failed to load heatmap data", e);
      }
    }

    // Language Helper
    function setLang(code, name) {
      changeLanguage(code);
      document.getElementById('currentLangLabel').innerText = name;
      // Close dropdown (css group-hover handles it, but creating a cleaner UI might need JS, for now CSS hover is fine as requested "scrolling button")
      // To persist label on load:
      localStorage.setItem('netra_lang_name', name);
    }

    // On load, set label
    window.addEventListener('load', () => {
      const name = localStorage.getItem('netra_lang_name') || 'English';
      const label = document.getElementById('currentLangLabel');
      if (label) label.innerText = name;
    });

    // Hook into showSection to ensuring map renders correctly
    const originalShowSection = showSection;
    showSection = function (id, btn) {
      originalShowSection(id, btn);
      if (id === 'map') {
        setTimeout(() => {
          if (!mapInstance) initMap();
          mapInstance.invalidateSize();
        }, 100);
      }
    }
  </script>


  <script src="{{ url_for('static', filename='js/translations.js') }}"></script>
</body>

</html>